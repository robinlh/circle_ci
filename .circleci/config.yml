# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
workflows:
  build-singularity:
    jobs:
      - build:
          context: dockerhub
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run: |
            echo $DOCKERHUB_PASSWORD | docker login --username $DOCKERHUB_USERNAME --password-stdin 
            docker pull roblhall/singularity

            docker create -v /sfiles --name singularity_files alpine:3.4 /bin/true
            docker cp test_container/ singularity_files:/sfiles

            docker run --privileged --volumes-from singularity_files roblhall/singularity build /sfiles/test_container/python_app.simg /sfiles/test_container/python_app.def
            docker cp singularity_files:/sfiles/test_container/python_app.simg test_container/
 
      - run: |
            touch test_container/token
            echo $HUB_TOKEN > test_container/token
            
            docker create -v /token_folder --name token_files alpine:3.4 /bin/true
            docker cp test_container/ token_files:/token_folder
            docker run --privileged --volumes-from token_files roblhall/singularity remote add -i --password $HUB_TOKEN hinkskalle http://sregistry.ilifu.ac.za
              
    
  

